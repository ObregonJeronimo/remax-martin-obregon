<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin ¬∑ Mart√≠n Obreg√≥n RE/MAX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        :root { --navy: #0B1D3A; --navy-light: #132B52; --gold: #C9A84C; --gold-light: #E4C76B; --cream: #FAF7F0; --white: #FFFFFF; --gray-100: #F5F3EE; --gray-200: #E8E4DB; --gray-400: #A09B8E; --gray-600: #6B6559; --gray-800: #3D3A34; --green: #16a34a; --red: #dc2626; --radius: 12px; --radius-lg: 20px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--cream); color: var(--gray-800); min-height: 100vh; }
        h1, h2, h3 { font-family: 'DM Serif Display', serif; color: var(--navy); }
        .login-view { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(160deg, var(--navy) 0%, #132B52 100%); padding: 24px; }
        .login-card { background: var(--white); border-radius: var(--radius-lg); box-shadow: 0 20px 60px rgba(0,0,0,0.2); max-width: 420px; width: 100%; padding: 48px 40px; text-align: center; }
        .login-card h1 { font-size: 1.8rem; margin-bottom: 8px; }
        .login-card p { color: var(--gray-400); margin-bottom: 32px; }
        .google-btn { display: inline-flex; align-items: center; gap: 12px; background: var(--white); border: 2px solid var(--gray-200); padding: 14px 32px; border-radius: 50px; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1rem; font-weight: 600; color: var(--navy); cursor: pointer; transition: all 0.3s ease; width: 100%; justify-content: center; }
        .google-btn:hover { border-color: var(--gold); background: var(--gray-100); }
        .google-btn img { width: 22px; height: 22px; }
        .login-error { background: #fef2f2; border: 1px solid #fecaca; color: var(--red); padding: 12px 16px; border-radius: var(--radius); margin-top: 16px; font-size: 0.9rem; display: none; }
        .admin-view { display: none; }
        .admin-topbar { background: var(--navy); padding: 0 32px; height: 64px; display: flex; align-items: center; justify-content: space-between; color: var(--white); position: sticky; top: 0; z-index: 50; }
        .admin-topbar h2 { color: var(--white); font-size: 1.1rem; }
        .admin-user { display: flex; align-items: center; gap: 12px; }
        .admin-user img { width: 32px; height: 32px; border-radius: 50%; }
        .admin-user span { font-size: 0.85rem; color: rgba(255,255,255,0.7); }
        .logout-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 8px 20px; border-radius: 50px; font-size: 0.85rem; cursor: pointer; transition: all 0.3s; }
        .logout-btn:hover { background: var(--red); border-color: var(--red); }
        .admin-body { padding: 32px; max-width: 1100px; margin: 0 auto; }
        .admin-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px; }
        .stat-card { background: var(--white); border-radius: var(--radius); padding: 24px; border: 1px solid var(--gray-200); }
        .stat-card .num { font-family: 'DM Serif Display', serif; font-size: 2rem; color: var(--navy); }
        .stat-card .label { color: var(--gray-400); font-size: 0.85rem; margin-top: 4px; }
        .admin-section { background: var(--white); border-radius: var(--radius-lg); border: 1px solid var(--gray-200); margin-bottom: 24px; overflow: hidden; }
        .admin-section-header { padding: 24px 28px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--gray-200); }
        .admin-section-header h3 { font-size: 1.2rem; }
        .add-btn { background: var(--gold); color: var(--navy); border: none; padding: 10px 24px; border-radius: 50px; font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; }
        .add-btn:hover { background: var(--gold-light); }
        .prop-list { padding: 0; }
        .prop-row { display: grid; grid-template-columns: 1fr auto auto auto; align-items: center; gap: 16px; padding: 20px 28px; border-bottom: 1px solid var(--gray-100); transition: background 0.2s; }
        .prop-row:hover { background: var(--gray-100); }
        .prop-row-info h4 { font-size: 1rem; color: var(--navy); font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 600; }
        .prop-row-info span { font-size: 0.85rem; color: var(--gray-400); }
        .prop-row-price { font-family: 'DM Serif Display', serif; font-size: 1.1rem; color: var(--navy); white-space: nowrap; }
        .prop-row-status { padding: 5px 14px; border-radius: 50px; font-size: 0.78rem; font-weight: 700; text-transform: uppercase; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-inactive { background: #fef3c7; color: #92400e; }
        .prop-row-actions { display: flex; gap: 8px; }
        .icon-btn { width: 36px; height: 36px; border-radius: 50%; border: 1px solid var(--gray-200); background: var(--white); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: all 0.2s; }
        .icon-btn:hover { background: var(--gray-100); }
        .icon-btn.delete:hover { background: #fef2f2; border-color: var(--red); }
        .modal-overlay { position: fixed; inset: 0; z-index: 100; background: rgba(11,29,58,0.6); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; padding: 24px; }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--white); border-radius: var(--radius-lg); max-width: 560px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 36px; animation: cardIn 0.3s ease; }
        @keyframes cardIn { from { opacity: 0; transform: scale(0.95) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal h2 { font-size: 1.5rem; margin-bottom: 24px; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; font-weight: 600; font-size: 0.85rem; color: var(--navy); margin-bottom: 6px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 16px; border: 1.5px solid var(--gray-200); border-radius: var(--radius); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 0.95rem; color: var(--gray-800); transition: border 0.2s; background: var(--white); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-check { display: flex; align-items: center; gap: 10px; padding: 12px 0; }
        .form-check input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--gold); }
        .form-check label { margin: 0; cursor: pointer; }
        .modal-actions { display: flex; gap: 12px; margin-top: 28px; justify-content: flex-end; }
        .btn-cancel { padding: 12px 28px; border-radius: 50px; border: 1.5px solid var(--gray-200); background: var(--white); cursor: pointer; font-weight: 600; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.2s; }
        .btn-cancel:hover { background: var(--gray-100); }
        .btn-save { padding: 12px 28px; border-radius: 50px; border: none; background: var(--navy); color: var(--white); cursor: pointer; font-weight: 600; font-family: 'Plus Jakarta Sans', sans-serif; transition: all 0.2s; }
        .btn-save:hover { background: var(--navy-light); }
        .btn-delete-confirm { background: var(--red); color: white; border: none; padding: 12px 28px; border-radius: 50px; cursor: pointer; font-weight: 600; font-family: 'Plus Jakarta Sans', sans-serif; }
        .empty-state { padding: 60px 28px; text-align: center; color: var(--gray-400); }
        .empty-state span { font-size: 3rem; display: block; margin-bottom: 12px; }
        .toast { position: fixed; bottom: 24px; right: 24px; z-index: 200; background: var(--navy); color: white; padding: 14px 24px; border-radius: var(--radius); font-weight: 500; box-shadow: 0 8px 32px rgba(0,0,0,0.2); transform: translateY(100px); opacity: 0; transition: all 0.4s ease; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--green); }
        .toast.error { background: var(--red); }
        .fetch-btn { background: var(--gold); color: var(--navy); border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-family: 'Plus Jakarta Sans', sans-serif; font-weight: 600; font-size: 0.8rem; margin-top: 8px; transition: all 0.3s; }
        .fetch-btn:hover { background: var(--gold-light); }
        .fetch-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .fetch-status { font-size: 0.82rem; color: var(--gray-400); margin-top: 6px; min-height: 20px; }
        .fetch-status.ok { color: var(--green); }
        .fetch-status.err { color: var(--red); }
        .photos-preview { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; max-height: 120px; overflow-y: auto; }
        .photos-preview img { width: 80px; height: 50px; object-fit: cover; border-radius: 6px; border: 2px solid var(--gray-200); }
        .photos-preview img:first-child { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(201,168,76,0.3); }
        .photo-count { font-size: 0.78rem; color: var(--gold); font-weight: 600; margin-top: 4px; }
        @media (max-width: 700px) { .admin-body { padding: 16px; } .prop-row { grid-template-columns: 1fr; gap: 8px; } .form-row { grid-template-columns: 1fr; } .modal { padding: 24px; } }
    </style>
</head>
<body>

<div class="login-view" id="loginView">
    <div class="login-card">
        <div style="font-size:3rem; margin-bottom:16px;">üîê</div>
        <h1>Panel Admin</h1>
        <p>Acceso exclusivo para Mart√≠n Obreg√≥n</p>
        <button class="google-btn" onclick="loginGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
            Iniciar sesi√≥n con Google
        </button>
        <div class="login-error" id="loginError"></div>
    </div>
</div>

<div class="admin-view" id="adminView">
    <div class="admin-topbar">
        <h2>üè† Admin ¬∑ RE/MAX</h2>
        <div class="admin-user">
            <img id="userPhoto" src="" alt="" style="display:none;">
            <span id="userEmail"></span>
            <button class="logout-btn" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
    </div>
    <div class="admin-body">
        <div class="admin-stats">
            <div class="stat-card"><div class="num" id="totalProps">0</div><div class="label">Propiedades totales</div></div>
            <div class="stat-card"><div class="num" id="activeProps">0</div><div class="label">Activas</div></div>
            <div class="stat-card"><div class="num" id="inactiveProps">0</div><div class="label">Inactivas</div></div>
        </div>
        <div class="admin-section">
            <div class="admin-section-header"><h3>Propiedades</h3><button class="add-btn" onclick="openModal()">+ Agregar propiedad</button></div>
            <div class="prop-list" id="propList"><div class="empty-state"><span>üì¶</span>Cargando propiedades...</div></div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal">
        <h2 id="modalTitle">Agregar propiedad</h2>
        <input type="hidden" id="editId">
        <div class="form-group"><label>T√≠tulo *</label><input type="text" id="fTitulo" placeholder="Ej: Casa 3 dormitorios en Sald√°n"></div>
        <div class="form-row">
            <div class="form-group"><label>Tipo *</label><select id="fTipo"><option value="casa">Casa</option><option value="terreno">Terreno</option><option value="departamento">Departamento</option></select></div>
            <div class="form-group"><label>Ubicaci√≥n *</label><input type="text" id="fUbicacion" placeholder="Ej: Sald√°n, C√≥rdoba"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Moneda</label><select id="fMoneda"><option value="USD">USD</option><option value="ARS">ARS</option></select></div>
            <div class="form-group"><label>Precio *</label><input type="number" id="fPrecio" placeholder="97500"></div>
        </div>
        <div class="form-group"><label>Detalle precio (opcional)</label><input type="text" id="fPrecioDetalle" placeholder="Ej: Financiaci√≥n disponible"></div>
        <div class="form-row">
            <div class="form-group"><label>Superficie</label><input type="text" id="fSuperficie" placeholder="Ej: 675m¬≤"></div>
            <div class="form-group"><label>Dormitorios</label><input type="number" id="fDormitorios" placeholder="3"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Ba√±os</label><input type="number" id="fBanos" placeholder="2"></div>
            <div class="form-group"><label>URL imagen (opcional)</label><input type="url" id="fImagen" placeholder="Se auto-completa con fotos RE/MAX"></div>
        </div>
        <div class="form-group"><label>Descripci√≥n</label><textarea id="fDescripcion" placeholder="Descripci√≥n detallada de la propiedad..."></textarea></div>
        <div class="form-group">
            <label>üîó Enlace RE/MAX</label>
            <input type="url" id="fEnlace" placeholder="https://www.remax.com.ar/420471269-1">
            <button class="fetch-btn" id="fetchPhotosBtn" onclick="fetchRemaxPhotos()">üì∏ Buscar fotos de RE/MAX</button>
            <div class="fetch-status" id="fetchStatus"></div>
            <div class="photos-preview" id="photosPreview"></div>
            <div class="photo-count" id="photoCount"></div>
        </div>
        <div class="form-check"><input type="checkbox" id="fAptaCredito"><label for="fAptaCredito">‚úÖ Apta cr√©dito hipotecario</label></div>
        <div class="form-check"><input type="checkbox" id="fActiva" checked><label for="fActiva">Activa (visible en el cat√°logo)</label></div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">Cancelar</button>
            <button class="btn-save" onclick="saveProperty()">Guardar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="deleteOverlay">
    <div class="modal" style="max-width:400px; text-align:center;">
        <div style="font-size:3rem; margin-bottom:12px;">‚ö†Ô∏è</div>
        <h2>¬øEliminar propiedad?</h2>
        <p style="color:var(--gray-400); margin-bottom:24px;">Esta acci√≥n no se puede deshacer.</p>
        <input type="hidden" id="deleteId">
        <div class="modal-actions" style="justify-content:center;">
            <button class="btn-cancel" onclick="closeDelete()">Cancelar</button>
            <button class="btn-delete-confirm" onclick="confirmDelete()">Eliminar</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyANxvb5BlOEP2LHeQIbtN3KrEY8t4L2oHA",
        authDomain: "remax-martin-obregon.firebaseapp.com",
        projectId: "remax-martin-obregon",
        storageBucket: "remax-martin-obregon.firebasestorage.app",
        messagingSenderId: "712927618620",
        appId: "1:712927618620:web:3b43f38b2f7cb1552c8539"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const ADMIN_EMAIL = 'martinobregon72@gmail.com';

    let extractedPhotos = [];

    async function fetchRemaxPhotos() {
        const enlace = document.getElementById('fEnlace').value.trim();
        const statusEl = document.getElementById('fetchStatus');
        const previewEl = document.getElementById('photosPreview');
        const countEl = document.getElementById('photoCount');
        const btn = document.getElementById('fetchPhotosBtn');
        if (!enlace || !enlace.includes('remax.com.ar')) {
            statusEl.textContent = '‚ö†Ô∏è Peg√° un enlace v√°lido de remax.com.ar';
            statusEl.className = 'fetch-status err';
            return;
        }
        btn.disabled = true;
        statusEl.textContent = 'üîÑ Buscando fotos...';
        statusEl.className = 'fetch-status';
        previewEl.innerHTML = '';
        countEl.textContent = '';
        extractedPhotos = [];
        try {
            const proxies = ['https://api.allorigins.win/raw?url=', 'https://corsproxy.io/?'];
            let html = '';
            for (const proxy of proxies) {
                try { const r = await fetch(proxy + encodeURIComponent(enlace)); if (r.ok) { html = await r.text(); break; } } catch(e) { continue; }
            }
            if (!html) throw new Error('No se pudo acceder a la p√°gina');
            const regex = /listings\/([a-f0-9-]{36})\/(?:\d+x\d+\/)?([a-f0-9-]{36})\.jpg/gi;
            const found = new Set();
            let match, listingUuid = '';
            while ((match = regex.exec(html)) !== null) { listingUuid = match[1]; found.add(match[2]); }
            if (found.size === 0 || !listingUuid) {
                statusEl.textContent = '‚ùå No se encontraron fotos en este enlace';
                statusEl.className = 'fetch-status err';
                btn.disabled = false;
                return;
            }
            extractedPhotos = [...found].map(pid => `https://d1acdg20u0pmxj.cloudfront.net/listings/${listingUuid}/860x440/${pid}.jpg`);
            previewEl.innerHTML = extractedPhotos.slice(0, 6).map((url, i) => `<img src="${url}" alt="Foto ${i+1}" title="Foto ${i+1}">`).join('') + (extractedPhotos.length > 6 ? `<div style="display:flex;align-items:center;font-size:0.8rem;color:var(--gray-400);">+${extractedPhotos.length-6} m√°s</div>` : '');
            countEl.textContent = `‚úÖ ${extractedPhotos.length} fotos encontradas ¬∑ La 1ra ser√° la portada`;
            statusEl.textContent = '';
            statusEl.className = 'fetch-status ok';
            if (!document.getElementById('fImagen').value) document.getElementById('fImagen').value = extractedPhotos[0];
        } catch (e) {
            console.error('Error fetching photos:', e);
            statusEl.textContent = '‚ùå ' + e.message;
            statusEl.className = 'fetch-status err';
        }
        btn.disabled = false;
    }

    auth.onAuthStateChanged(user => {
        if (user && user.email === ADMIN_EMAIL) showAdmin(user);
        else if (user) { auth.signOut(); showError('‚õî Acceso denegado.'); }
        else showLogin();
    });
    function loginGoogle() {
        const p = new firebase.auth.GoogleAuthProvider();
        p.setCustomParameters({ login_hint: ADMIN_EMAIL });
        auth.signInWithPopup(p).catch(e => showError('Error: ' + e.message));
    }
    function logout() { auth.signOut(); }
    function showLogin() { document.getElementById('loginView').style.display='flex'; document.getElementById('adminView').style.display='none'; }
    function showAdmin(user) {
        document.getElementById('loginView').style.display='none';
        document.getElementById('adminView').style.display='block';
        document.getElementById('userEmail').textContent=user.email;
        if(user.photoURL){const p=document.getElementById('userPhoto');p.src=user.photoURL;p.style.display='block';}
        loadAdminProperties();
    }
    function showError(msg) { const el=document.getElementById('loginError'); el.textContent=msg; el.style.display='block'; }
    function toast(msg, type='success') { const el=document.getElementById('toast'); el.textContent=msg; el.className=`toast ${type} show`; setTimeout(()=>el.classList.remove('show'),3000); }

    let adminProperties = [];
    async function loadAdminProperties() {
        try {
            const snap = await db.collection('propiedades').orderBy('createdAt','desc').get();
            adminProperties = snap.docs.map(d=>({id:d.id,...d.data()}));
            renderAdminList(); updateStats();
        } catch(e) { console.error(e); document.getElementById('propList').innerHTML='<div class="empty-state"><span>‚ùå</span>Error cargando</div>'; }
    }
    function updateStats() {
        const a=adminProperties.filter(p=>p.activa).length;
        document.getElementById('totalProps').textContent=adminProperties.length;
        document.getElementById('activeProps').textContent=a;
        document.getElementById('inactiveProps').textContent=adminProperties.length-a;
    }
    function renderAdminList() {
        const list=document.getElementById('propList');
        if(!adminProperties.length){list.innerHTML='<div class="empty-state"><span>üè†</span>No hay propiedades. ¬°Agreg√° la primera!</div>';return;}
        const emojis={casa:'üè†',terreno:'üå≥',departamento:'üè¢'};
        list.innerHTML=adminProperties.map(p=>{
            const pc=(p.imagenes&&p.imagenes.length)||0;
            return `<div class="prop-row">
                <div class="prop-row-info"><h4>${emojis[p.tipo]||'üè†'} ${p.titulo||'Sin t√≠tulo'}</h4><span>üìç ${p.ubicacion||'-'} ¬∑ ${p.superficie||'-'}${pc?' ¬∑ üì∏ '+pc+' fotos':''}</span></div>
                <div class="prop-row-price">${p.moneda||'USD'} ${p.precio?Number(p.precio).toLocaleString('es-AR'):'-'}</div>
                <span class="prop-row-status ${p.activa?'status-active':'status-inactive'}">${p.activa?'Activa':'Inactiva'}</span>
                <div class="prop-row-actions"><button class="icon-btn" onclick="editProperty('${p.id}')" title="Editar">‚úèÔ∏è</button><button class="icon-btn delete" onclick="openDelete('${p.id}')" title="Eliminar">üóëÔ∏è</button></div>
            </div>`}).join('');
    }

    function openModal(id) {
        document.getElementById('modalOverlay').classList.add('open');
        document.getElementById('modalTitle').textContent=id?'Editar propiedad':'Agregar propiedad';
        document.getElementById('editId').value=id||'';
        extractedPhotos=[];
        document.getElementById('fetchStatus').textContent='';
        document.getElementById('photosPreview').innerHTML='';
        document.getElementById('photoCount').textContent='';
        if(id){
            const p=adminProperties.find(x=>x.id===id);
            if(p){
                document.getElementById('fTitulo').value=p.titulo||'';
                document.getElementById('fTipo').value=p.tipo||'casa';
                document.getElementById('fUbicacion').value=p.ubicacion||'';
                document.getElementById('fMoneda').value=p.moneda||'USD';
                document.getElementById('fPrecio').value=p.precio||'';
                document.getElementById('fPrecioDetalle').value=p.precioDetalle||'';
                document.getElementById('fSuperficie').value=p.superficie||'';
                document.getElementById('fDormitorios').value=p.dormitorios||'';
                document.getElementById('fBanos').value=p.banos||'';
                document.getElementById('fImagen').value=p.imagen||'';
                document.getElementById('fDescripcion').value=p.descripcion||'';
                document.getElementById('fEnlace').value=p.enlace||'';
                document.getElementById('fAptaCredito').checked=!!p.aptaCredito;
                document.getElementById('fActiva').checked=p.activa!==false;
                if(p.imagenes&&p.imagenes.length){
                    extractedPhotos=p.imagenes;
                    document.getElementById('photosPreview').innerHTML=extractedPhotos.slice(0,6).map((u,i)=>`<img src="${u}" alt="Foto ${i+1}">`).join('')+(extractedPhotos.length>6?`<div style="display:flex;align-items:center;font-size:0.8rem;color:var(--gray-400);">+${extractedPhotos.length-6} m√°s</div>`:'');
                    document.getElementById('photoCount').textContent=`üì∏ ${extractedPhotos.length} fotos guardadas`;
                }
            }
        } else clearForm();
    }
    function editProperty(id){openModal(id);}
    function closeModal(){document.getElementById('modalOverlay').classList.remove('open');clearForm();}
    function clearForm(){
        ['fTitulo','fUbicacion','fPrecio','fPrecioDetalle','fSuperficie','fDormitorios','fBanos','fImagen','fDescripcion','fEnlace'].forEach(id=>document.getElementById(id).value='');
        document.getElementById('fTipo').value='casa'; document.getElementById('fMoneda').value='USD';
        document.getElementById('fAptaCredito').checked=false; document.getElementById('fActiva').checked=true;
        document.getElementById('editId').value='';
        extractedPhotos=[];
        document.getElementById('fetchStatus').textContent='';
        document.getElementById('photosPreview').innerHTML='';
        document.getElementById('photoCount').textContent='';
    }

    async function saveProperty() {
        const titulo=document.getElementById('fTitulo').value.trim();
        const ubicacion=document.getElementById('fUbicacion').value.trim();
        const precio=document.getElementById('fPrecio').value;
        if(!titulo||!ubicacion||!precio){toast('Complet√° t√≠tulo, ubicaci√≥n y precio','error');return;}
        const data = {
            titulo, tipo:document.getElementById('fTipo').value, ubicacion,
            moneda:document.getElementById('fMoneda').value, precio:Number(precio),
            precioDetalle:document.getElementById('fPrecioDetalle').value.trim(),
            superficie:document.getElementById('fSuperficie').value.trim(),
            dormitorios:Number(document.getElementById('fDormitorios').value)||null,
            banos:Number(document.getElementById('fBanos').value)||null,
            imagen:document.getElementById('fImagen').value.trim(),
            descripcion:document.getElementById('fDescripcion').value.trim(),
            enlace:document.getElementById('fEnlace').value.trim(),
            aptaCredito:document.getElementById('fAptaCredito').checked,
            activa:document.getElementById('fActiva').checked,
            imagenes: extractedPhotos.length > 0 ? extractedPhotos : [],
            updatedAt:firebase.firestore.FieldValue.serverTimestamp()
        };
        const editId=document.getElementById('editId').value;
        try {
            if(editId){await db.collection('propiedades').doc(editId).update(data);toast('‚úÖ Propiedad actualizada');}
            else{data.createdAt=firebase.firestore.FieldValue.serverTimestamp();await db.collection('propiedades').add(data);toast('‚úÖ Propiedad agregada');}
            closeModal(); loadAdminProperties();
        } catch(e){console.error(e);toast('Error: '+e.message,'error');}
    }

    function openDelete(id){document.getElementById('deleteId').value=id;document.getElementById('deleteOverlay').classList.add('open');}
    function closeDelete(){document.getElementById('deleteOverlay').classList.remove('open');}
    async function confirmDelete(){
        const id=document.getElementById('deleteId').value;
        try{await db.collection('propiedades').doc(id).delete();toast('üóëÔ∏è Eliminada');closeDelete();loadAdminProperties();}
        catch(e){toast('Error: '+e.message,'error');}
    }
    document.getElementById('modalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeModal();});
    document.getElementById('deleteOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeDelete();});
</script>
</body>
</html>